import { DefaultAzureCredential } from '@azure/identity';
import { SecretClient } from '@azure/keyvault-secrets';

const keyVaultUrl = process.env.KEY_VAULT_URL;

if (process.env.NODE_ENV === 'production' && !keyVaultUrl) {
  throw new Error('KEY_VAULT_URL environment variable is required in production.');
}

let client;

if (process.env.NODE_ENV === 'production') {
  const credential = new DefaultAzureCredential();
  client = new SecretClient(keyVaultUrl, credential);
}

export async function getSecret(secretName) {
  if (process.env.NODE_ENV !== 'production') {
    throw new Error('Secrets should not be fetched in development mode');
  }

  try {
    const secret = await client.getSecret(secretName);
    return secret.value;
  } catch (error) {
    console.error(`Error fetching secret ${secretName}:`, error.message);
    throw error;
  }
}