# Use the node image as the base
FROM node:20-alpine

# Install necessary packages and ClamAV dependencies, including netcat for debugging
RUN apk add --no-cache clamav clamav-libunrar tini netcat-openbsd

# Set the working directory
WORKDIR /app

# Copy package.json and package-lock.json
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy all application files
COPY . .

# Prepare ClamAV directories and logs
RUN mkdir -p /var/log/clamav /app/uploads /var/lib/clamav /run/clamav /tmp/clamav-scans \
    && chmod -R 777 /run/clamav /tmp/clamav-scans \
    && touch /var/log/freshclam.log /var/log/clamav/clamd.log \
    && freshclam \
    && rm -rf /var/cache/apk/*

# Expose the application's port
EXPOSE 3001

# Entrypoint with Tini to manage subprocesses
ENTRYPOINT ["/sbin/tini", "--"]

# Start the Node.js application
CMD ["node", "index.js"]